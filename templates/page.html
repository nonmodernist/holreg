{% extends "base.html" %}

{% block content %}
<article class="film-page">
    <div class="content-wrapper">
        <div class="main-content">
            <h1 class="film-title">{{ page.title }}</h1>
            
            {% if page.extra.original_story and page.extra.story_author %}
            <div class="film-description">
                <p><em>Adapted from</em> "{{ page.extra.original_story }}" <em>by</em> {{ page.extra.story_author }}{% if page.extra.story_year %} ({{ page.extra.story_year }}){% endif %}</p>
            </div>
            {% endif %}

            {% if page.extra.author_byline %}
            <div class="author-byline">
                by <span class="contributor-name">{{ page.extra.author_byline }}</span>
            </div>
            {% endif %}

            <div class="section">
                <div class="content-body">
                    {{ page.content | safe }}
                </div>
            </div>

            <!-- Citation Section -->
            {% if page.extra.show_citation %}
            <div class="section citation">
                <h2 class="citation-box-title">How to Cite This Page</h2>
                <div class="section-content">
                    <p class="citation-text">
                        {% if page.extra.author_byline %}{{ page.extra.author_byline }}. {% endif %}"{{ page.title }}." In <i>{{ config.title }}: A Digital Archive of Film Adaptations from American Women's Regional Literature, 1910-1961</i>. Web. Accessed [DATE]. &lt;{{ page.permalink }}&gt;
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Enhanced sidebar with action links and metadata -->
        <aside class="film-sidebar">
            <!-- Action links like WFP -->
            <div class="action-links">
                <a href="javascript:window.print()" class="print">Print</a>
            </div>

            <!-- Film image if available -->
            {% if page.extra.film_image %}
            <div class="film-image-container">
                <img src="{{ page.extra.film_image.url }}" alt="{{ page.extra.film_image.alt | default(value=page.title) }}">
                {% if page.extra.film_image.caption %}
                <div class="image-caption">{{ page.extra.film_image.caption }}</div>
                {% endif %}
            </div>
            {% endif %}

            {% if page.extra %}
            <div class="metadata-box">
                <h3>Film Details</h3>

                <div class="metadata-item">
                    <span class="label">Title</span>
                    <div class="value title-value"><i>{{ page.title }}</i></div>
                </div>

                {% if page.extra.year %}
                <div class="metadata-item">
                    <span class="label">Year</span>
                    <div class="value year-value">{{ page.extra.year }}</div>
                </div>
                {% endif %}

                {% if page.taxonomies.eras %}
                <div class="metadata-item">
                    <span class="label">Era</span>
                    <div class="value taxonomy-tags">
                        {% for era in page.taxonomies.eras %}
                        <a href="{{ get_taxonomy_url(kind='eras', name=era) }}" class="tag">{{ era }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if page.taxonomies.regions %}
                <div class="metadata-item">
                    <span class="label">Region</span>
                    <div class="value taxonomy-tags">
                        {% for region in page.taxonomies.regions %}
                        <a href="{{ get_taxonomy_url(kind='regions', name=region) }}" class="tag">{{ region }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if page.taxonomies.genres %}
                <div class="metadata-item">
                    <span class="label">Genres</span>
                    <div class="value taxonomy-tags">
                        {% for genre in page.taxonomies.genres %}
                        <a href="{{ get_taxonomy_url(kind='genres', name=genre) }}" class="tag">{{ genre }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Director - prefer taxonomy over extra -->
                {% if page.taxonomies.directors %}
                <div class="metadata-item">
                    <span class="label">Director</span>
                    <div class="value taxonomy-tags">
                        {% for director in page.taxonomies.directors %}
                        <a href="{{ get_taxonomy_url(kind='directors', name=director) }}" class="tag">{{ director }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                    {% if page.extra.director %}
                    <div class="metadata-item">
                        <span class="label">Director</span>
                        <div class="value">{{ page.extra.director }}</div>
                    </div>
                    {% endif %}
                {% endif %}

                <!-- Studio - prefer taxonomy over extra -->
                {% if page.taxonomies.studios %}
                <div class="metadata-item">
                    <span class="label">Studio</span>
                    <div class="value taxonomy-tags">
                        {% for studio in page.taxonomies.studios %}
                        <a href="{{ get_taxonomy_url(kind='studios', name=studio) }}" class="tag">{{ studio }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                    {% if page.extra.studio %}
                    <div class="metadata-item">
                        <span class="label">Studio</span>
                        <div class="value">{{ page.extra.studio }}</div>
                    </div>
                    {% endif %}
                {% endif %}
                
                {% if page.extra.stars %}
                <div class="metadata-item">
                    <span class="label">Stars</span>
                    <div class="value">
                        {% for star in page.extra.stars %}
                            {{ star }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if page.extra.format %}
                <div class="metadata-item">
                    <span class="label">Format</span>
                    <div class="value">{{ page.extra.format }}</div>
                </div>
                {% endif %}
                
                {% if page.extra.duration %}
                <div class="metadata-item">
                    <span class="label">Duration</span>
                    <div class="value">{{ page.extra.duration }}</div>
                </div>
                {% endif %}


<!-- FILM STATUS SECTION - survival and availability -->
    {% if page.extra.film_status %}
{% set status = page.extra.film_status %}

<!-- Survival Status - Always shown -->
<div class="metadata-item">
    <span class="label">Survival</span>
    <div class="value">
        <span class="status-survival status-{{ status.survival }}">
            {% if status.survival == "extant" %}
                {{ status.completeness | title }}
            {% else %}
                {{ status.survival | title }}
            {% endif %}
        </span>
    </div>
</div>

<!-- Availability - Only for extant films -->
{% if status.survival == "extant" %}
<div class="metadata-item">
    <span class="label">Availability</span>
    <div class="value">
        <span class="status-access status-{{ status.access }}">
            {% if status.access == "available" %}
                Available
                {% if status.availability_type == "internet_archive" %}
                    (Free Online)
                {% elif status.availability_type == "dvd" %}
                    (DVD)
                {% elif status.availability_type == "streaming" %}
                    (Streaming)
                {% endif %}
            {% elif status.access == "restricted" %}
                Archive Access Only
            {% else %}
                Not Available
            {% endif %}
        </span>
    </div>
</div>
{% endif %}

<!-- Notes - Show if present -->
{% if status.availability_notes %}
<div class="metadata-item">
    <span class="label">{% if status.survival == "extant" %}Availability Notes{% else %}Notes{% endif %}</span>
    <div class="value">{{ status.availability_notes }}</div>
</div>
{% endif %}
{% endif %}
<!-- Add this to your page.html template in the film sidebar, after the Film Details box -->

<!-- Internet Archive Availability -->
{% if page.extra.internet_archive and page.extra.internet_archive.available %}
<div class="metadata-box ia-availability">
    <h3>üé¨ Watch Online</h3>
    
    <div class="ia-badge-container">
        <span class="ia-badge">Free on Internet Archive</span>
    </div>
    
    <div class="ia-actions">
        <a href="{{ page.extra.internet_archive.watch_url }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="ia-watch-btn">
            ‚ñ∂Ô∏è Watch Now
        </a>
        
        <button onclick="toggleIAEmbed('{{ page.slug }}')" 
                class="ia-embed-btn">
            üì∫ Embed Player
        </button>
    </div>
    
    <div class="ia-details">
        <small>
            <strong>Archive ID:</strong> {{ page.extra.internet_archive.identifier }}<br>
            <strong>Last checked:</strong> {{ page.extra.internet_archive.last_checked }}
        </small>
    </div>
    
    <!-- Embedded player (hidden by default) -->
    <div id="ia-embed-{{ page.slug }}" class="ia-embed-container" style="display: none;">
        <div class="embed-header">
            <span>Internet Archive Player</span>
            <button onclick="toggleIAEmbed('{{ page.slug }}')" class="embed-close">‚úï</button>
        </div>
        <iframe src="{{ page.extra.internet_archive.embed_url }}" 
                width="100%" 
                height="480" 
                frameborder="0" 
                webkitallowfullscreen="true" 
                mozallowfullscreen="true" 
                allowfullscreen>
        </iframe>
    </div>
</div>
{% endif %}

<!-- Add CSS styles -->
<style>
.ia-availability {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
    border-left: 4px solid #4a90e2;
    padding: 1rem;
    margin: 1rem 0;
}

.ia-badge-container {
    margin-bottom: 1rem;
}

.ia-badge {
    display: inline-block;
    background: #4a90e2;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ia-actions {
    display: flex;
    gap: 0.75rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.ia-watch-btn, .ia-embed-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.ia-watch-btn {
    background: #28a745;
    color: white;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.ia-watch-btn:hover {
    background: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
}

.ia-embed-btn {
    background: #6c757d;
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

.ia-embed-btn:hover {
    background: #5a6268;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(108, 117, 125, 0.4);
}

.ia-details {
    color: #666;
    line-height: 1.4;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #ddd;
}

.ia-embed-container {
    margin: 1rem 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.embed-header {
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    font-size: 0.9rem;
    font-weight: 500;
}

.embed-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #666;
    padding: 0;
    line-height: 1;
}

.embed-close:hover {
    color: #333;
}

.ia-embed-container iframe {
    display: block;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .ia-actions {
        flex-direction: column;
    }
    
    .ia-watch-btn, .ia-embed-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<!-- JavaScript for embed toggle -->
<script>
function toggleIAEmbed(filmSlug) {
    const container = document.getElementById('ia-embed-' + filmSlug);
    const iframe = container.querySelector('iframe');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        // Scroll to the player
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        container.style.display = 'none';
    }
}
</script>

</div>




<!-- SOURCE DETAILS BOX -->
            {% if page.extra.original_story %}
            <div class="metadata-box">
                <h3>Source Details</h3>
                
                <div class="metadata-item">
                    <span class="label">Adapted From</span>
                    <div class="value title-value"><i>{{ page.extra.original_story }}</i></div>
                </div>

                {% if page.taxonomies.authors %}
                <div class="metadata-item">
                    <span class="label">Author</span>
                    <div class="value taxonomy-tags">
                        {% for author in page.taxonomies.authors %}
                        <a href="{{ get_taxonomy_url(kind='authors', name=author) }}" class="tag">{{ author }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if page.extra.story_year %}
                <div class="metadata-item">
                    <span class="label">Published</span>
                    <div class="value">{{ page.extra.story_year }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}

<!-- Production Details Box -->
            {% if page.extra.production_company or page.extra.distributor or page.extra.filming_locations %}
            <div class="metadata-box">
                <h3>Production</h3>
                
                {% if page.extra.production_company %}
                <div class="metadata-item">
                    <span class="label">Production Company</span>
                    <div class="value">{{ page.extra.production_company }}</div>
                </div>
                {% endif %}
                
                {% if page.extra.distributor %}
                <div class="metadata-item">
                    <span class="label">Distributor</span>
                    <div class="value">{{ page.extra.distributor }}</div>
                </div>
                {% endif %}
                
                {% if page.extra.filming_locations %}
                <div class="metadata-item">
                    <span class="label">Filmed</span>
                    <div class="value">
                        {% for location in page.extra.filming_locations %}
                            {{ location }}{% if not loop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

<!-- Additional Details Box (if any other metadata exists) -->
            {% if page.extra.adaptation_notes %}
            <div class="metadata-box">
                <h3>Notes</h3>
                
                <div class="metadata-item">
                    <span class="label">Adaptation Notes</span>
                    <div class="value">{{ page.extra.adaptation_notes }}</div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </aside>
    </div>
</article>
{% endblock content %}